%% manual testing script for PLAX view id

%{

    1. threshold and binarise image to show approximate shapes for key
    features of view

    2. using predicted centroids, build an ellipse of best fit for each
    feature

    3. repeat using the best fit centroid, use both ellipses to create a
    predicted feature ellipse

    4. Compare shape of the PFE to expected shape

    5. Measure image gradient/sharpness

    Results :

        - Compare the position of the PFEs, do they imply that all key
        features are present in the image?
    
        - Compare the size/shape of all PFEs, do they imply that key
        features are correctly represented?

        - Is the image sharpness/gradient distribution appropriate for use?

    For an initial attempt we will identify the Left Ventricle, Right
    Ventricle, Aorta, and Left Atrium

%}

%% temporary master data set (to be replaced with measured data from "good" images

% coordinates for framing the triangle mask
master_frame_l = [53,424];
master_frame_r = [679,424];
master_frame_t = [411,5];

% Predicted feature centroids and deviations
lv_centroid = [357,251];
lv_deviation = 5;
rv_centroid = [438,146];
rv_deviation = 5;
ao_centroid = [522,271];
ao_deviation = 5;
la_centroid = [472,378];
la_deviation = 5;

% predicted feature ellipse parameters (add when required)

% generated feature variables
lv_found = false;
rv_found = false;
ao_found = false;
la_found = false;


%% load image 
img = imread('plax_1.jpg');
figure;
idisp(img);

% convert image to greyscale format
if ndims(img) == 3
    img_grey = rgb2gray(img);
else
    img_grey = img;
end

%% scale intensities
% noise reduction
g = kgauss(5,2);
img_smooth = iconvolve(img_grey,2*g);


% contrast enhancement
h = [0 -1 0; -1 5 -1; 0 -1 0];
img_enhanced = iconvolve(img_smooth, h);

% rescale
img_enhanced = double(img_enhanced);
img_enhanced = img_enhanced - min(img_enhanced(:));
img_enhanced = img_enhanced / max(img_enhanced(:));

figure;
idisp(img_enhanced);

%% Threshold

bw = img_enhanced > 0.14;
bw = double(bw);

figure;
idisp(bw);

%% sort image by adding triangle frame to act as edges
top = master_frame_t;
left = master_frame_l;
right = master_frame_r;

% add lines
bw = insertShape(bw, 'Line', [top(1), top(2), left(1), left(2)], 'Color', 'white', 'Linewidth', 5);
bw = insertShape(bw, 'Line', [top(1), top(2), right(1), right(2)], 'Color', 'white', 'Linewidth', 5);

% Create triangle mask
triangle_mask = poly2mask([top(1),left(1), right(1)], [top(2),left(2),right(2)], size(bw,1), size(bw,2));
bw(~triangle_mask) = 1; 

figure;
idisp(bw);

%% convert to logical b/w
bw = logical(rgb2gray(bw));
figure;
idisp(bw);
hold on;

%% find and choose predicted feature centroids (and plot for debug)

% Left Atrium
la_box = [la_centroid(1) - la_deviation, la_centroid(2) - la_deviation, la_centroid(1) + la_deviation, la_centroid(2) + la_deviation];
plot_box(la_box(1),la_box(2),la_box(3),la_box(4),'g','LineWidth',1);
text(la_box(3),la_box(4), ...
    "LA", 'Color','y','FontSize',10,'FontWeight','bold');


% Left ventricle
lv_box = [lv_centroid(1) - lv_deviation, lv_centroid(2) - lv_deviation, lv_centroid(1) + lv_deviation, lv_centroid(2) + lv_deviation];
plot_box(lv_box(1),lv_box(2),lv_box(3),lv_box(4),'g','LineWidth',1);
text(lv_box(3),lv_box(4), ...
    "LV", 'Color','y','FontSize',10,'FontWeight','bold');

% Right ventricle
rv_box = [rv_centroid(1) - rv_deviation, rv_centroid(2) - rv_deviation, rv_centroid(1) + rv_deviation, rv_centroid(2) + rv_deviation];
plot_box(rv_box(1),rv_box(2),rv_box(3),rv_box(4),'g','LineWidth',1);
text(rv_box(3),rv_box(4), ...
    "RV", 'Color','y','FontSize',10,'FontWeight','bold');

% Aorta
ao_box = [ao_centroid(1) - ao_deviation, ao_centroid(2) - ao_deviation, ao_centroid(1) + ao_deviation, ao_centroid(2) + ao_deviation];
plot_box(ao_box(1),ao_box(2),ao_box(3),ao_box(4),'g','LineWidth',1);
text(ao_box(3),ao_box(4), ...
    "AO", 'Color','y','FontSize',10,'FontWeight','bold');

hold off;

%% Select a black pixel from within the centroid boxes to act as the center

% left atrium
first_la_centroid = selectPredictedCentroid(bw, la_centroid, la_deviation);

if first_la_centroid ~= [0,0]
    la_found = true;
end

% left ventricle
first_lv_centroid = selectPredictedCentroid(bw, lv_centroid, lv_deviation);

if first_lv_centroid ~= [0,0]
    lv_found = true;
end

% right ventricle
first_rv_centroid = selectPredictedCentroid(bw, rv_centroid, rv_deviation);

if first_rv_centroid ~= [0,0]
    rv_found = true;
end

% aorta
first_ao_centroid = selectPredictedCentroid(bw, ao_centroid, ao_deviation);

if first_ao_centroid ~= [0,0]
    ao_found = true;
end


% if any of the features cant be found, their weighting will be set to 0
% which will nullify the final result

